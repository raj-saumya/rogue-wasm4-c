#include "types.h"
#include "wasm4.h"
#include <stdlib.h>

#define DEMON_TYPE_A_W 64
#define DEMON_TYPE_A_H 16
#define DEMON_TYPE_A_FRAME_SIZE 16
#define DEMON_TYPE_A_FRAME_COUNT 4
#define DEMON_TYPE_A_ANIM_SPEED 10
#define DEMON_TYPE_A_DIR BLIT_2BPP

const uint8_t DEMON_TYPE_A_SPRITE[256] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x0c, 0xc0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xff, 0x3f, 0xc0, 0x00, 0xcc, 0x0c, 0xc0, 0x00, 0xcc, 0x0c, 0xc0,
    0x00, 0xcc, 0x3c, 0xc0, 0x00, 0xd7, 0xf7, 0xc0, 0x00, 0xfc, 0x3f, 0xc0,
    0x00, 0xfc, 0x3f, 0xc0, 0x00, 0xfc, 0xff, 0x00, 0x00, 0x37, 0xdf, 0x00,
    0x00, 0xd7, 0xe7, 0x00, 0x00, 0xdb, 0xe7, 0x00, 0x00, 0xdf, 0xe7, 0x00,
    0x00, 0xf9, 0x9f, 0x00, 0x00, 0x37, 0xf7, 0x00, 0x00, 0x3d, 0x7c, 0x00,
    0x00, 0x29, 0x6c, 0x00, 0x03, 0xef, 0x7b, 0x00, 0x00, 0xf9, 0x9c, 0x00,
    0x00, 0x39, 0x9c, 0x00, 0x03, 0xe9, 0x5c, 0x00, 0x03, 0x96, 0xe7, 0x00,
    0x03, 0xed, 0x7b, 0x00, 0x00, 0xe7, 0xfc, 0x00, 0x03, 0xad, 0xff, 0x00,
    0x03, 0xe5, 0x97, 0x00, 0x03, 0x96, 0x97, 0x00, 0x00, 0xe7, 0xdc, 0x00,
    0x03, 0x9b, 0x97, 0x00, 0x00, 0xff, 0x6c, 0x00, 0x03, 0xe6, 0x5f, 0x00,
    0x00, 0xf9, 0x6c, 0x00, 0x03, 0xa6, 0x9f, 0x00, 0x00, 0x37, 0xfc, 0x00,
    0x00, 0xff, 0x7c, 0x00, 0x00, 0x3f, 0x5c, 0x00, 0x00, 0xfd, 0x7c, 0x00,
    0x00, 0x3d, 0xdc, 0x00, 0x00, 0x3d, 0xdc, 0x00, 0x00, 0x3d, 0xdc, 0x00,
    0x00, 0x3d, 0xdc, 0x00};

#define DEMON_TYPE_B_W 64
#define DEMON_TYPE_B_H 16
#define DEMON_TYPE_B_FRAME_SIZE 16
#define DEMON_TYPE_B_FRAME_COUNT 4
#define DEMON_TYPE_B_ANIM_SPEED 10
#define DEMON_TYPE_B_DIR BLIT_2BPP

const uint8_t DEMON_TYPE_B_SPRITE[256] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x03, 0x0f, 0xf0, 0xc0, 0x03, 0x0f, 0xf0, 0xc0, 0x00, 0x00, 0x00, 0x00,
    0x03, 0x0f, 0xf0, 0xc0, 0x0d, 0xf5, 0x5f, 0x70, 0x0c, 0xff, 0xff, 0x30,
    0x03, 0x0f, 0xf0, 0xc0, 0x0d, 0xf5, 0x5f, 0x70, 0x0e, 0xda, 0xab, 0xb0,
    0x0c, 0xbf, 0xfe, 0x30, 0x0d, 0xf5, 0x5f, 0x70, 0x0e, 0xda, 0xab, 0xb0,
    0x0f, 0x6f, 0xfa, 0xf0, 0x0e, 0xff, 0x5f, 0xb0, 0x0e, 0xda, 0xab, 0xb0,
    0x0f, 0x6f, 0xfa, 0xf0, 0x0d, 0xbf, 0x5e, 0xb0, 0x0f, 0xfd, 0x07, 0xf0,
    0x0f, 0x6f, 0xfa, 0xf0, 0x0d, 0xbf, 0xfe, 0xb0, 0x0e, 0xfd, 0x97, 0xf0,
    0x0f, 0xf4, 0x01, 0xf0, 0x0d, 0xbf, 0x5e, 0xb0, 0x0e, 0xff, 0xff, 0xf0,
    0x0f, 0xfd, 0xa7, 0xf0, 0x0f, 0xf4, 0x01, 0xf0, 0x0e, 0xfd, 0x97, 0xf0,
    0x0f, 0xff, 0xff, 0xf0, 0x0f, 0xff, 0x5f, 0xf0, 0x0f, 0xfd, 0x07, 0xf0,
    0x0f, 0xfd, 0xa7, 0xf0, 0x0f, 0xff, 0xff, 0xf0, 0x0f, 0xff, 0xff, 0xf0,
    0x0e, 0xff, 0x5f, 0xb0, 0x0f, 0xff, 0x5f, 0xf0, 0x0f, 0xff, 0xff, 0xf0,
    0x03, 0xff, 0xff, 0xc0, 0x01, 0xbf, 0xff, 0xc0, 0x0f, 0xff, 0xff, 0xf0,
    0x03, 0xff, 0xff, 0xc0, 0x00, 0xff, 0xff, 0xc0, 0x00, 0xff, 0xfe, 0xc0,
    0x03, 0xff, 0xff, 0xc0, 0x00, 0xff, 0xff, 0xc0, 0x00, 0xff, 0xff, 0x00,
    0x00, 0xef, 0xff, 0x00, 0x00, 0xff, 0xff, 0xc0, 0x00, 0xff, 0xff, 0x00,
    0x00, 0xff, 0xfc, 0x00, 0x00, 0xee, 0xec, 0x00, 0x00, 0xff, 0xff, 0x00,
    0x00, 0xff, 0xfc, 0x00, 0x00, 0x33, 0x30, 0x00, 0x00, 0x33, 0x30, 0x00,
    0x00, 0xff, 0xfc, 0x00, 0x00, 0x33, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x33, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00};

void Demon_render(Demon *demon, uint32_t frame_count) {
  *DRAW_COLORS = 0x4320;

  uint32_t anim_frame =
      (frame_count / DEMON_TYPE_A_ANIM_SPEED) % DEMON_TYPE_A_FRAME_COUNT;
  uint32_t src_x = anim_frame * DEMON_TYPE_A_FRAME_SIZE;

  blitSub(DEMON_TYPE_A_SPRITE, demon->pos_x, demon->pos_y,
          DEMON_TYPE_A_FRAME_SIZE, DEMON_TYPE_A_H, src_x, 0, DEMON_TYPE_A_W,
          DEMON_TYPE_A_DIR);
}

void Demon_render_all(GameContext *gc) {
  for (int i = 0; i < DEMON_COUNT; i++) {
    if (gc->demons[i].is_alive) {
      Demon_render(&gc->demons[i], gc->frame_count);
    }
  }
}

bool check_player_collision(Demon *demon, Player *player) {
  int dx = demon->pos_x;
  int dy = demon->pos_y;
  int px = player->pos_x;
  int py = player->pos_y;

  if (dx >= px && dx <= px + DEMON_SPRITE_FRAME_SIZE && dy >= py &&
      dy <= py + DEMON_SPRITE_H) {
    return true;
  }

  return false;
}

// Moves all alive demons towards the player.
// Uses a simplified boids algorithm: seek the player + avoid overlapping
// neighbors.
void Demon_swarm_tracking(GameContext *gc) {
  // Skip this frame if it's not time to move yet.
  // This slows down movement to make demons feel sluggish.
  if (gc->frame_count % DEMON_MOVE_SPEED != 0) {
    return;
  }

  // Target the center of the player sprite, not the top-left corner
  int player_center_x = gc->player.pos_x + (DEMON_SPRITE_FRAME_SIZE / 2);
  int player_center_y = gc->player.pos_y + (DEMON_SPRITE_H / 2);

  for (int i = 0; i < DEMON_COUNT; i++) {
    Demon *current_demon = &gc->demons[i];

    if (!current_demon->is_alive) {
      continue;
    }

    if (check_player_collision(current_demon, &gc->player)) {
      gc->player.health -= 1;
      continue;
    }

    int next_x = current_demon->pos_x;
    int next_y = current_demon->pos_y;

    // Move one pixel closer to the player center on each axis
    if (next_x < player_center_x)
      next_x += 1;
    else if (next_x > player_center_x)
      next_x -= 1;

    if (next_y < player_center_y)
      next_y += 1;
    else if (next_y > player_center_y)
      next_y -= 1;

    // Push away from neighbors to prevent stacking.
    // We only check adjacent array slots to keep this O(n) instead of O(nÂ²).
    int push_x = 0;
    int push_y = 0;

    if (i > 0) {
      Demon *prev_demon = &gc->demons[i - 1];
      if (prev_demon->is_alive) {
        int dx = next_x - prev_demon->pos_x;
        int dy = next_y - prev_demon->pos_y;
        if (abs(dx) < DEMON_SEPARATION_DIST &&
            abs(dy) < DEMON_SEPARATION_DIST) {
          push_x += (dx > 0) ? 1 : -1;
          push_y += (dy > 0) ? 1 : -1;
        }
      }
    }

    if (i < DEMON_COUNT - 1) {
      Demon *next_demon = &gc->demons[i + 1];
      if (next_demon->is_alive) {
        int dx = next_x - next_demon->pos_x;
        int dy = next_y - next_demon->pos_y;
        if (abs(dx) < DEMON_SEPARATION_DIST &&
            abs(dy) < DEMON_SEPARATION_DIST) {
          push_x += (dx > 0) ? 1 : -1;
          push_y += (dy > 0) ? 1 : -1;
        }
      }
    }

    current_demon->pos_x = next_x + push_x;
    current_demon->pos_y = next_y + push_y;
  }
}
